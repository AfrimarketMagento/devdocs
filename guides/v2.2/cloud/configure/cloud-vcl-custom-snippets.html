<!DOCTYPE html>
<html lang="en" dir="ltr" class="no-js">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width initial-scale=1" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<title>Custom Fastly VCL snippets | Magento 2 Developer Documentation</title>
	<meta name="description" content="Magento 2 Developer Documentation.
">
	<meta http-equiv="last-modified" content="" />

	<link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,700,600,300,800' rel='stylesheet' type='text/css'>

	<link rel="stylesheet" href="/css/app.css" />
	<link rel="stylesheet" href="/css/print.css" media="print" />
	<link rel="canonical" href="//guides/v2.2/cloud/configure/cloud-vcl-custom-snippets.html">

    <!-- WebUI popover css -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/jquery.webui-popover/1.2.1/jquery.webui-popover.min.css">

  <script>
    var baseUrl = "/";
  </script>

	<!-- crazyegg -->
	<script type="text/javascript">
	setTimeout(function(){var a=document.createElement("script");
	var b=document.getElementsByTagName("script")[0];
	a.src=document.location.protocol+"//script.crazyegg.com/pages/scripts/0038/0321.js?"+Math.floor(new Date().getTime()/3600000);
	a.async=true;a.type="text/javascript";b.parentNode.insertBefore(a,b)}, 1);
	</script>

    <!-- heap analytics -->
    <script type="text/javascript">
        window.heap=window.heap||[],heap.load=function(e,t){window.heap.appid=e,window.heap.config=t=t||{};var r=t.forceSSL||"https:"===document.location.protocol,a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src=(r?"https:":"http:")+"//cdn.heapanalytics.com/js/heap-"+e+".js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(a,n);for(var o=function(e){return function(){heap.push([e].concat(Array.prototype.slice.call(arguments,0)))}},p=["addEventProperties","addUserProperties","clearEventProperties","identify","removeEventProperty","setEventProperties","track","unsetEventProperty"],c=0;c<p.length;c++)heap[p[c]]=o(p[c])};
        heap.load("2619540280");
    </script>

	<link rel="shortcut icon" type="image/vnd.microsoft.icon" href="https://magento.com/favicon.ico">
	<link rel="apple-touch-icon" type="image/png" href="https://magento.com/apple-touch-icon.png">
	<link rel="apple-touch-icon" type="image/png" sizes="57x57" href="https://magento.com/apple-touch-icon-57x57.png">
	<link rel="apple-touch-icon" type="image/png" sizes="72x72" href="https://magento.com/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="https://magento.com/apple-touch-icon-76x76.png">
	<link rel="apple-touch-icon" type="image/png" sizes="114x114" href="https://magento.com/apple-touch-icon-114x114.png">
	<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="https://magento.com/apple-touch-icon-120x120.png">
	<link rel="apple-touch-icon" type="image/png" sizes="144x144" href="https://magento.com/apple-touch-icon-144x144.png">
	<link rel="apple-touch-icon" type="image/png" sizes="152x152" href="https://magento.com/apple-touch-icon-152x152.png">
	<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="https://magento.com/apple-touch-icon-180x180.png">

</head>
<body>

<header class="site-header">

	<nav id="global-nav">

		<div class="menu-btn"><a class="menu-trigger menu-icon" href="#" data-proofer-ignore></a></div>

		<div class="container">

			<a class="logo" href="/"><img src="/i/m-logo.svg" alt=""><img src="/i/magento-logo.svg" alt="Magento" class="magento-logo" /><img src="/i/devdocs-logo.svg" alt="Devdocs" class="devdocs-logo" /></a>

			
<div class="version-switcher dropdown" data-version="2.2">
	<button id="version-switcher-button" class="btn btn-small dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        Magento 2.2
	</button>

	<ul class="dropdown-menu dropdown-menu-left" aria-labelledby="version-switcher-button">
	
		<li><a class="dropdown-item" data-proofer-ignore href="/guides/v2.0/cloud/configure/cloud-vcl-custom-snippets.html">Magento 2.0</a></li>
	
		<li><a class="dropdown-item" data-proofer-ignore href="/guides/v2.1/cloud/configure/cloud-vcl-custom-snippets.html">Magento 2.1</a></li>
	
		<li><a class="dropdown-item" data-proofer-ignore href="/guides/v2.2/cloud/configure/cloud-vcl-custom-snippets.html">Magento 2.2</a></li>
	
  </ul>

</div>



			<nav class="nav-main" role="menubar">

  <div class="nav-main-item" tabindex="0" role="menuitem" aria-haspopup="true">
    <a href="#" data-proofer-ignore tabindex="-1">Setup</a>

    <div class="nav-popup" role="menu" aria-hidden="true">
      <ul>
          <li><a href="/guides/v2.2/install-gde/bk-install-guide.html">Installation Guide</a></li>
          
          <li><a href="/guides/v2.2/comp-mgr/bk-compman-upgrade-guide.html">Extension Update and System Upgrade Guide</a></li>
          
          <li><a href="/guides/v2.2/config-guide/bk-config-guide.html">Configuration Guide</a></li>
          <li><a href="/guides/v2.2/migration/bk-migration-guide.html">Migration Guide</a></li>
          <li><a href="/guides/v2.2/cloud/bk-cloud.html">Magento Commerce (Cloud) Guide</a></li>
          <li><a href="/magento-release-information.html">Release Information</a></li>
      </ul>
    </div>

  </div>


  <div class="nav-main-item" tabindex="0" role="menuitem" aria-haspopup="true">
    <a href="#" data-proofer-ignore tabindex="-1">Development</a>

    <div class="nav-popup" role="menu" aria-hidden="true">

      <div class="nav-section">
        <div class="nav-section-title">Backend</div>
        <ul>
          <li><a href="/guides/v2.2/architecture/bk-architecture.html">Architecture Guide</a></li>
          <li><a href="/guides/v2.2/extension-dev-guide/bk-extension-dev-guide.html">PHP Developer Guide</a></li>
          <li><a href="/guides/v2.2/ext-best-practices/bk-ext-best-practices.html">Extension Developer Best Practices</a></li>
          <li><a href="/guides/v2.2/mrg/intro.html">Module Reference Guide</a></li>
          <li><a href="/guides/v2.2/coding-standards/bk-coding-standards.html">Coding Standards</a></li>
          <li><a href="/guides/v2.2/contributor-guide/contributing.html">Contributor Guide</a></li>
        </ul>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">Frontend</div>
        <ul>
          <li class=""><a href="/guides/v2.2/frontend-dev-guide/bk-frontend-dev-guide.html">Frontend Developer Guide</a></li>
          
          <li><a href="/guides/v2.2/ui_comp_guide/bk-ui_comps.html">UI Components Guide</a></li>
          
          <li><a href="/guides/v2.2/javascript-dev-guide/bk-javascript-dev-guide.html">JavaScript Developer Guide</a></li>
          <li><a href="/guides/v2.2/pattern-library/bk-pattern.html">Admin Design Pattern Library</a></li>
          <li><a href="/guides/v2.2/design-styleguide/bk-styleguide.html">Admin Style Guide</a></li>
        </ul>
      </div>

      <div class="nav-section">
        <div class="nav-section-title"><abbr>API</abbr></div>
        <ul>
          <li><a href="/guides/v2.2/get-started/bk-get-started-api.html">Get Started with Magento Web APIs</a></li>
          <li><a href="/guides/v2.2/rest/bk-rest.html">REST API Reference</a></li>
          <li><a href="/guides/v2.2/soap/bk-soap.html">SOAP API Reference</a></li>
          
        </ul>
      </div>
    </div>

  </div>


  <div class="nav-main-item" tabindex="0" role="menuitem" aria-haspopup="true">
    <a href="#" data-proofer-ignore tabindex="-1">Testing</a>

    <div class="nav-popup" role="menu" aria-hidden="true">
      <ul>
        <li><a href="/guides/v2.2/test/testing.html">Magento Testing Guide</a></li>
        
        <li><a href="/guides/v2.2/magento-functional-testing-framework/introduction.html">Functional Acceptance Testing (New!)</a></li>
        
        <li><a href="/guides/v2.2/mtf/mtf_introduction.html">Functional Testing</a></li>
        <li><a href="/guides/v2.2/test/integration/integration_test_execution.html">Integration Testing</a></li>
        <li><a href="/guides/v2.2/test/js/jasmine.html">JavaScript Unit Testing</a></li>
        <li><a href="/guides/v2.2/test/unit/unit_test_execution.html">PHP Unit Testing</a></li>
        <li><a href="/guides/v2.2/get-started/web-api-functional-testing.html">Web API Functional Testing</a></li>
      </ul>
    </div>

  </div>


  <div class="nav-main-separator"></div>


  <div class="nav-main-item" tabindex="0" role="menuitem" aria-haspopup="true">
    <a href="#" data-proofer-ignore tabindex="-1">Functional Areas</a>

    <div class="nav-popup" role="menu" aria-hidden="true">
      <ul>
          
          <li class="leaf"><a href="/guides/v2.2/advanced-reporting/overview.html">Advanced Reporting</a></li>
          
        
        <li class="leaf"><a href="/guides/v2.2/b2b/bk-b2b.html">B2B</a></li>
        
        <li><a href="/guides/v2.2/howdoi/checkout/checkout_overview.html">Checkout</a></li>
        <li><a href="/guides/v2.2/payments-integrations/bk-payments-integrations.html">Payment Integrations</a></li>
        
          <li><a href="/guides/v2.2/extension-dev-guide/staging.html">Staging</a></li>
        
      </ul>
    </div>

  </div>


  <div class="nav-main-item"  tabindex="0" role="menuitem" aria-haspopup="true">
    <a href="#" data-proofer-ignore tabindex="-1">Tutorials</a>

    <div class="nav-popup" role="menu" aria-hidden="true">
      <ul>
        <li><a href="/guides/v2.2/howdoi/bk-how-do-i.html">How To</a></li>
        
        <li><a  data-proofer-ignore href="/guides/v2.2/get-started/order-tutorial/order-intro.html">Order Processing with REST APIs</a></li>
        

        <li><a href="/videos/">Video Tutorials</a></li>
      </ul>
    </div>

  </div>

</nav><!-- /.nav-main -->


			<div class="search-btn">
				<a class="search-trigger search-icon" href="/search.html"></a>
			</div>

			<form class="quick-search" action="/guides/v2.2/search.html" method="get">
				<input type="search" name="q" placeholder="Search" autocomplete="off" />
				<a href="#" data-proofer-ignore class="quick-search-close">&times;</a>
			</form>

		</div>

	</nav><!-- #global-nav -->

</header>
<div class="nav-main-fader"></div>


<div id="gl-wrapper">

	<!-- .main-container -->
	<div class="main-container">
		<a id="main-content"></a>


<div class="container">

	<!-- sidebar -->
<aside class="sidebar">
	<a href="#" data-proofer-ignore class="toc-toggler">Table of Contents</a>
	<div class="sidebar-wrapper">



<h4></h4>
<div class="left-navigation">
    <ul>
    
    

<li class="nav-level1  " id="welcome-to-magento-commerce-(cloud)">

    
    <div class="toggle closed">&nbsp;</div>
    
    
    
    <a href="/guides/v2.2/cloud/bk-cloud.html">Welcome to Magento Commerce (Cloud)</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="subscriptions-and-plans">
            
            
        
            
            <a href="/guides/v2.2/cloud/basic-information/cloud-plans.html">Subscriptions and plans</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="starter-architecture">
            
            
        
            
            <a href="/guides/v2.2/cloud/basic-information/starter-architecture.html">Starter architecture</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="starter-develop-and-deploy-workflow">
            
            
        
            
            <a href="/guides/v2.2/cloud/basic-information/starter-develop-deploy-workflow.html">Starter develop and deploy workflow</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="pro-architecture">
            
            
        
            
            <a href="/guides/v2.2/cloud/reference/discover-arch.html">Pro architecture</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="pro-develop-and-deploy-workflow">
            
            
        
            
            <a href="/guides/v2.2/cloud/welcome/discover-workflow.html">Pro develop and deploy workflow</a>
            

            
        </li>
        
        
    </ul>
    
</li>


    
    

<li class="nav-level1  " id="onboarding-tasks">

    
    <div class="toggle closed">&nbsp;</div>
    
    
    
    <a href="/guides/v2.2/cloud/onboarding/onboarding-tasks.html">Onboarding tasks</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="onboarding-portal-management">
            
            
        
            
            <a href="/guides/v2.2/cloud/onboarding/onboarding-portal.html">Onboarding Portal management</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="prepare-project-environments">
            
            
        
            
            <a href="/guides/v2.2/cloud/before/before-project-owner.html">Prepare project environments</a>
            

            
        </li>
        
        
    </ul>
    
</li>


    
    

<li class="nav-level1  " id="technologies-and-requirements">

    
    <div class="toggle closed">&nbsp;</div>
    
    
    
    <a href="/guides/v2.2/cloud/requirements/cloud-requirements.html">Technologies and requirements</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="composer">
            
            
        
            
            <a href="/guides/v2.2/cloud/reference/cloud-composer.html">Composer</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="magento-cloud-cli">
            
            
        
            
            <a href="/guides/v2.2/cloud/reference/cli-ref-topic.html">Magento Cloud CLI</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="git">
            
            
        
            
            <a href="/guides/v2.2/cloud/reference/git-integration.html">Git</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="bitbucket-integration">
            
            
        
            
            <a href="/guides/v2.2/cloud/project/bitbucket-integration.html">Bitbucket integration</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="github-integration">
            
            
        
            
            <a href="/guides/v2.2/cloud/project/project-integrate-github.html">GitHub integration</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="ssh-and-sftp">
            
            
        
            
            <a href="/guides/v2.2/cloud/env/environments-ssh.html">SSH and sFTP</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="new-relic-apm">
            
            
        
            
            <a href="/guides/v2.2/cloud/project/new-relic.html">New Relic APM</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="blackfire-profiler">
            
            
        
            
            <a href="/guides/v2.2/cloud/project/project-integrate-blackfire.html">Blackfire Profiler</a>
            

            
        </li>
        
        
    </ul>
    
</li>


    
    

<li class="nav-level1  " id="local-environment-setup">

    
    <div class="toggle closed">&nbsp;</div>
    
    
    
    <a href="/guides/v2.2/cloud/access-acct/first-time-setup.html">Local environment setup</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="prepare-for-local-environment-setup">
            
            
        
            
            <a href="/guides/v2.2/cloud/before/before-workspace.html">Prepare for local environment setup</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="install-magento-prerequisites">
            
            
        
            
            <a href="/guides/v2.2/cloud/before/before-workspace-magento-prereqs.html">Install Magento prerequisites</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="enable-ssh-keys">
            
            
        
            
            <a href="/guides/v2.2/cloud/before/before-workspace-ssh.html">Enable SSH keys</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="set-up-the-magento-file-system-owner">
            
            
        
            
            <a href="/guides/v2.2/cloud/before/before-workspace-file-sys-owner.html">Set up the Magento file system owner</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="clone-and-branch-the-project">
            
            
        
            
            <a href="/guides/v2.2/cloud/before/before-setup-env-2_clone.html">Clone and branch the project</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="install-magento">
            
            
        
            
            <a href="/guides/v2.2/cloud/before/before-setup-env-install.html">Install Magento</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="first-time-deployment">
            
            
        
            
            <a href="/guides/v2.2/cloud/access-acct/first-time-deploy.html">First time deployment</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="optional---install-sample-data">
            
            
        
            
            <a href="/guides/v2.2/cloud/howtos/sample-data.html">Optional - Install sample data</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="optional---configure-xdebug">
            
            
        
            
            <a href="/guides/v2.2/cloud/howtos/debug.html">Optional - Configure Xdebug</a>
            

            
        </li>
        
        
    </ul>
    
</li>


    
    

<li class="nav-level1  " id="import-existing-code-into-a-project">

    
    <div class="toggle closed">&nbsp;</div>
    
    
    
    <a href="/guides/v2.2/cloud/access-acct/first-time-setup_import-first-steps.html">Import existing code into a project</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="prepare-your-existing-magento-commerce-system">
            
            
        
            
            <a href="/guides/v2.2/cloud/access-acct/first-time-setup_import-prepare.html">Prepare your existing Magento Commerce system</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="import-magento-commerce-into-magento-commerce-(cloud)">
            
            
        
            
            <a href="/guides/v2.2/cloud/access-acct/first-time-setup_import-import.html">Import Magento Commerce into Magento Commerce (Cloud)</a>
            

            
        </li>
        
        
    </ul>
    
</li>


    
    

<li class="nav-level1  " id="configure-your-store">

    
    <div class="toggle closed">&nbsp;</div>
    
    
    
    <a href="/guides/v2.2/cloud/configure/configuration-overview.html">Configure your store</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="best-practices-for-store-configuration">
            
            
        
            
            <a href="/guides/v2.2/cloud/configure/configure-best-practices.html">Best practices for store configuration</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="set-up-paypal">
            
            
        
            
            <a href="/guides/v2.2/cloud/live/paypal-onboarding.html">Set up PayPal</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="set-up-magento-b2b">
            
            
        
            
            <a href="/guides/v2.2/cloud/configure/setup-b2b.html">Set up Magento B2B</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="set-up-cron-jobs">
            
            
        
            
            <a href="/guides/v2.2/cloud/configure/setup-cron-jobs.html">Set up cron jobs</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="set-up-multiple-cloud-websites-or-stores">
            
            
        
            
            <a href="/guides/v2.2/cloud/project/project-multi-sites.html">Set up multiple Cloud websites or stores</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="install,-manage,-and-upgrade-modules">
            
            
        
            
            <a href="/guides/v2.2/cloud/howtos/install-components.html">Install, manage, and upgrade modules</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="install-a-theme">
            
            
        
            
            <a href="/guides/v2.2/cloud/howtos/custom-theme.html">Install a theme</a>
            

            
        </li>
        
        
    </ul>
    
</li>


    
    

<li class="nav-level1  " id="configure-fastly">

    
    <div class="toggle closed">&nbsp;</div>
    
    
    
    <a href="/guides/v2.2/cloud/basic-information/cloud-fastly.html">Configure Fastly</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="set-up-fastly">
            
            
        
            
            <a href="/guides/v2.2/cloud/access-acct/fastly.html">Set up Fastly</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2 active " id="custom-fastly-vcl-snippets">
            
            
        
            
            <a href="/guides/v2.2/cloud/configure/cloud-vcl-custom-snippets.html">Custom Fastly VCL snippets</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="custom-whitelist-vcl">
            
            
        
            
            <a href="/guides/v2.2/cloud/configure/fastly-vcl-whitelist.html">Custom whitelist VCL</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="custom-blacklist-vcl">
            
            
        
            
            <a href="/guides/v2.2/cloud/configure/fastly-vcl-blacklist.html">Custom blacklist VCL</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="custom-extend-admin-timeout-vcl">
            
            
        
            
            <a href="/guides/v2.2/cloud/configure/fastly-vcl-extend-timeout.html">Custom extend Admin timeout VCL</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="custom-redirect-to-wordpress-vcl">
            
            
        
            
            <a href="/guides/v2.2/cloud/configure/fastly-vcl-wordpress.html">Custom redirect to Wordpress VCL</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="custom-block-bad-referer-vcl">
            
            
        
            
            <a href="/guides/v2.2/cloud/configure/fastly-vcl-badreferer.html">Custom block bad referer VCL</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="fastly-troubleshooting">
            
            
        
            
            <a href="/guides/v2.2/cloud/trouble/trouble_fastly.html">Fastly troubleshooting</a>
            

            
        </li>
        
        
    </ul>
    
</li>


    
    

<li class="nav-level1  " id="configure-environments">

    
    <div class="toggle closed">&nbsp;</div>
    
    
    
    <a href="/guides/v2.2/cloud/env/environments.html">Configure environments</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="configure-.magento.app.yaml">
            
            
        
            
            <a href="/guides/v2.2/cloud/project/project-conf-files_magento-app.html">Configure .magento.app.yaml</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="configure-services---services.yaml">
            
            
        
            
            <a href="/guides/v2.2/cloud/project/project-conf-files_services.html">Configure services - services.yaml</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="set-up-mysql-service">
            
            
        
            
            <a href="/guides/v2.2/cloud/project/project-conf-files_services-mysql.html">Set up MySQL service</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="set-up-redis-service">
            
            
        
            
            <a href="/guides/v2.2/cloud/project/project-conf-files_services-redis.html">Set up Redis service</a>
            

            
        </li>
        
        
        
        
        
        
        <li class="nav-level2  " id="set-up-elasticsearch-service">
            
            
        
            
            <a href="/guides/v2.2/cloud/project/project-conf-files_services-elastic.html">Set up Elasticsearch service</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="set-up-rabbitmq-service">
            
            
        
            
            <a href="/guides/v2.2/cloud/project/project-conf-files_services-rabbit.html">Set up RabbitMQ service</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="set-up-notifications">
            
            
        
            
            <a href="/guides/v2.2/cloud/env/setup-notifications.html">Set up notifications</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="configure-routes---routes.yaml">
            
            
        
            
            <a href="/guides/v2.2/cloud/project/project-conf-files_routes.html">Configure routes - routes.yaml</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="caching">
            
            
        
            
            <a href="/guides/v2.2/cloud/project/project-routes-more-cache.html">Caching</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="redirects">
            
            
        
            
            <a href="/guides/v2.2/cloud/project/project-routes-more-redir.html">Redirects</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="server-side-includes">
            
            
        
            
            <a href="/guides/v2.2/cloud/project/project-routes-more-ssi.html">Server side includes</a>
            

            
        </li>
        
        
    </ul>
    
</li>


    
    

<li class="nav-level1  " id="configuration-management-for-store-settings">

    
    <div class="toggle closed">&nbsp;</div>
    
    
    
    <a href="/guides/v2.2/cloud/live/sens-data-over.html">Configuration management for store settings</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="example-of-managing-system-specific-settings">
            
            
        
            
            <a href="/guides/v2.2/cloud/live/sens-data-initial.html">Example of managing system-specific settings</a>
            

            
        </li>
        
        
    </ul>
    
</li>


    
    

<li class="nav-level1  " id="manage-your-project">

    
    <div class="toggle closed">&nbsp;</div>
    
    
    
    <a href="/guides/v2.2/cloud/project/projects.html">Manage your project</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="configure-your-project">
            
            
        
            
            <a href="/guides/v2.2/cloud/project/project-webint-basic.html">Configure your project</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="project-structure">
            
            
        
            
            <a href="/guides/v2.2/cloud/project/project-start.html">Project structure</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="create-and-manage-users">
            
            
        
            
            <a href="/guides/v2.2/cloud/project/user-admin.html">Create and manage users</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="manage-branches-with-the-interface">
            
            
        
            
            <a href="/guides/v2.2/cloud/project/project-webint-branch.html">Manage branches with the Interface</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="manage-branches-with-the-cli">
            
            
        
            
            <a href="/guides/v2.2/cloud/env/environments-start.html">Manage branches with the CLI</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="snapshots-and-backup-management">
            
            
        
            
            <a href="/guides/v2.2/cloud/project/project-webint-snap.html">Snapshots and backup management</a>
            

            
        </li>
        
        
    </ul>
    
</li>


    
    

<li class="nav-level1  " id="manage-variables">

    
    <div class="toggle closed">&nbsp;</div>
    
    
    
    <a href="/guides/v2.2/cloud/env/environment-vars_over.html">Manage variables</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="magento-application-environment-variables">
            
            
        
            
            <a href="/guides/v2.2/cloud/env/environment-vars_magento.html">Magento application environment variables</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="magento-commerce-(cloud)-environment-variables">
            
            
        
            
            <a href="/guides/v2.2/cloud/env/environment-vars_cloud.html">Magento Commerce (Cloud) environment variables</a>
            

            
        </li>
        
        
    </ul>
    
</li>


    
    

<li class="nav-level1  " id="upgrades-and-patches">

    
    <div class="toggle closed">&nbsp;</div>
    
    
    
    <a href="/guides/v2.2/cloud/project/project-upgrade-parent.html">Upgrades and Patches</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="upgrade-magento-commerce-(cloud)">
            
            
        
            
            <a href="/guides/v2.2/cloud/project/project-upgrade.html">Upgrade Magento Commerce (Cloud)</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="patch-magento-commerce-(cloud)">
            
            
        
            
            <a href="/guides/v2.2/cloud/project/project-patch.html">Patch Magento Commerce (Cloud)</a>
            

            
        </li>
        
        
        
        
    </ul>
    
</li>


    
    

<li class="nav-level1  " id="deploy-your-store">

    
    <div class="toggle closed">&nbsp;</div>
    
    
    
    <a href="/guides/v2.2/cloud/live/stage-prod-live.html">Deploy your store</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="deployment-process">
            
            
        
            
            <a href="/guides/v2.2/cloud/reference/discover-deploy.html">Deployment process</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="continuous-deployment">
            
            
        
            
            <a href="/guides/v2.2/cloud/deploy/continuous-deployment.html">Continuous deployment</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="protective-block">
            
            
        
            
            <a href="/guides/v2.2/cloud/live/live-prot.html">Protective block</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="build-and-deploy-on-local">
            
            
        
            
            <a href="/guides/v2.2/cloud/live/live-sanity-check.html">Build and deploy on local</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="prepare-to-deploy-to-staging-and-production">
            
            
        
            
            <a href="/guides/v2.2/cloud/live/stage-prod-migrate-prereq.html">Prepare to deploy to Staging and Production</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="deploy-code-and-migrate-static-files-and-data">
            
            
        
            
            <a href="/guides/v2.2/cloud/live/stage-prod-migrate.html">Deploy code and migrate static files and data</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="test-deployment">
            
            
        
            
            <a href="/guides/v2.2/cloud/live/stage-prod-test.html">Test deployment</a>
            

            
        </li>
        
        
    </ul>
    
</li>


    
    

<li class="nav-level1  " id="go-live-and-launch">

    
    <div class="toggle closed">&nbsp;</div>
    
    
    
    <a href="/guides/v2.2/cloud/live/live.html">Go live and launch</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="go-live-checklist">
            
            
        
            
            <a href="/guides/v2.2/cloud/live/go-live-checklist.html">Go live checklist</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="launch-steps">
            
            
        
            
            <a href="/guides/v2.2/cloud/live/launch-steps.html">Launch steps</a>
            

            
        </li>
        
        
    </ul>
    
</li>


    
    

<li class="nav-level1  " id="composer-package-updates">

    
    <div class="toggle closed">&nbsp;</div>
    
    
    
    <a href="/guides/v2.2/cloud/composer-packages/patch-notes.html">Composer package updates</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="magento/ece-patches">
            
            
        
            
            <a href="/guides/v2.2/cloud/composer-packages/ece-patches.html">magento/ece-patches</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="magento/ece-tools">
            
            
        
            
            <a href="/guides/v2.2/cloud/composer-packages/ece-tools.html">magento/ece-tools</a>
            

            
        </li>
        
        
    </ul>
    
</li>


    
    

<li class="nav-level1  " id="troubleshooting">

    
    <div class="toggle closed">&nbsp;</div>
    
    
    
    <a href="/guides/v2.2/cloud/trouble/trouble.html">Troubleshooting</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="add-staging-and-production-to-pro-projects-ui">
            
            
        
            
            <a href="/guides/v2.2/cloud/trouble/pro-env-management.html">Add Staging and Production to Pro projects UI</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="troubleshoot-deployment">
            
            
        
            
            <a href="/guides/v2.2/cloud/access-acct/trouble.html">Troubleshoot deployment</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="view-logs-for-troubleshooting">
            
            
        
            
            <a href="/guides/v2.2/cloud/trouble/environments-logs.html">View logs for troubleshooting</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="incorrect-credentials">
            
            
        
            
            <a href="/guides/v2.2/cloud/trouble/trouble_ce-creds.html">Incorrect credentials</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="resolve-issues-with-a-new-project">
            
            
        
            
            <a href="/guides/v2.2/cloud/trouble/trouble_proj-startover.html">Resolve issues with a new project</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="component-deployment-failure">
            
            
        
            
            <a href="/guides/v2.2/cloud/trouble/trouble_comp-deploy-fail.html">Component deployment failure</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="redis-troubleshooting">
            
            
        
            
            <a href="/guides/v2.2/cloud/trouble/redis-troubleshooting.html">Redis troubleshooting</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="resolve-issues-with-encryption-key">
            
            
        
            
            <a href="/guides/v2.2/cloud/trouble/trouble-crypt-key-variable.html">Resolve issues with encryption key</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="resolve-issues-with-html-minification">
            
            
        
            
            <a href="/guides/v2.2/cloud/trouble/trouble-error-html-minification.html">Resolve issues with HTML minification</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="resolve-issues-with-google-analytics-during-deployment">
            
            
        
            
            <a href="/guides/v2.2/cloud/trouble/trouble-google-analytics-deploy.html">Resolve issues with Google Analytics during deployment</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="add-sitemap-and-robots.txt">
            
            
        
            
            <a href="/guides/v2.2/cloud/trouble/robots-sitemap.html">Add sitemap and robots.txt</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="theme-troubleshooting">
            
            
        
            
            <a href="/guides/v2.2/cloud/trouble/theme-troubleshooting.html">Theme troubleshooting</a>
            

            
        </li>
        
        
    </ul>
    
</li>


    
    </ul>
</div>

	</div>

</aside>


<!-- /sidebar -->


	<section class="content">
		<div class="content-wrap">
			<!-- page-header -->
<section class="page-intro">
	

  <nav class="breadcrumbs">

    <a class="breadcrumb-item" href="/"><span>Home</span></a>

    <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

    <!-- Iteration breadcrumb item -->
    
    

    

      <!-- Skip if root -->
      

      <!-- Get breadcrumb title -->
      

      <!-- SEO data -->
      

      <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">

        
          <a property="item" typeof="WebPage" href="/guides/v2.2/cloud/bk-cloud.html">
            <span property="name">Welcome to Magento Commerce (Cloud)</span>
          </a>
        

        <meta property="position" content="1" />
      </li>

    

      <!-- Skip if root -->
      

      <!-- Get breadcrumb title -->
      

      <!-- SEO data -->
      

      <li class="breadcrumb-item active" property="itemListElement" typeof="ListItem">

        

          

          <span property="name">Custom Fastly VCL snippets</span>

        

        <meta property="position" content="2" />
      </li>

    

    



    </ol>

  </nav>



	

	

	<h1 class="page-heading">Custom Fastly VCL snippets</h1>

  


</section>


			<p><a href="/guides/v2.2/cloud/basic-information/cloud-fastly.html">Fastly</a> and Magento Commerce (Cloud) support creating custom Varnish Configuration Language (VCL) snippets. For best results, we recommend creating Edge Dictionaries and Edge ACLs for your VCL snippets. You’re free to customize your Fastly VCL snippets any way you like to complete custom code. The following examples and instructions walk through creating edge dictionaries, edge ACLs, and VCL snippets.</p>

<p>To create and upload these VCL snippets, you use a terminal application. You do not need to SSH into a specific environment. This information includes a walk-through creating regular snippets a bash command and <code class="highlighter-rouge">.vcl</code> snippet files of JSON code. <em>Don’t worry, we walk you through the process with examples.</em></p>

<p>You need the following information to create VCL snippets:</p>

<ul>
  <li>Fastly Service ID for Staging and Production to assign the snippets to a specific service or environment</li>
  <li>Fastly API key used for the <code class="highlighter-rouge">FASTLY_API_TOKEN</code> in the commands</li>
</ul>

<p>To get started, review the following sections:</p>

<ul>
  <li><a href="#vcl-curl">Understand VCL snippet values</a>: Provides an overview of values for Fastly VCL JSON.</li>
  <li><a href="#prepare">Prepare to create VCL snippets</a>: You only need to do this once!</li>
  <li><a href="#process">The custom VCL snippet process</a>: Walks you through the entire process, including links to custom VCL snippets you can create with ease.</li>
</ul>

<h2 id="vcl-curl">Understand VCL snippet values</h2>
<p>Your VCL snippets include the following values. You can use these key/value pairs in JSON snippets in <code class="highlighter-rouge">.vcl</code> files and in <code class="highlighter-rouge">cURL</code> commands.</p>

<table>
<tr>
    <th style="width: 150px;">Value</th>
    <th>Description</th>
</tr>
<tr>
<td>service_id</td>
<td>The ID indicates the specific Staging or Production service/environment. We provide this value. You will use this value when setting up your bash script for custom VCL snippets for <code>SERVICE_ID</code>.</td>
</tr>
<tr>
<td>API_KEY</td>
<td>The API Key for your Fastly account. We provide this value. You will add this value to your bash script.</td>
</tr>
<tr>
<td>version</td>
<td>The version of the service you add snippets to for validating and activating. Fastly uses <code>Editable Version #</code> in their example values. In the bash script, we use <code>SERVICE_ID_VERSION</code> for this value.</td>
</tr>
<tr>
<td>type</td>
<td>Specifies the location to place the generated snippet such as <code>init</code> (above subroutines) and within subroutines like <code>recv</code>. See <a href="https://docs.fastly.com/api/config#snippet">Fastly VCL snippet object values</a> for information on these values.</td>
</tr>
<tr>
<td>content</td>
<td>The snippet of VCL code to run. We recommend keeing this code all in one line. The VCL snippet code, cURL commands, and bash script require the content code in one line.</td>
</tr>
<tr>
<td>priority</td>
<td><p>Determines the order VCL snippets call. Lower values run first, from 1 to 100. All Magento module uploaded snippets are 50. If you want an action to occur last or override Magento default VCL snippets, enter a higher number like 100. To have code occur immediately, enter a lower value like 5.</p>
<p>Any VCL snippet at priority 5 will run immediately, best for blacklists, whitelists, and redirects. Priority 100 is best for overriding default VCL snippet code and values, best for extending timeouts. If you do not set a priority with your cURL command, the default value set is 100.</p></td>
</tr>
<tr>
<td>dynamic</td>
<td>Indicates if this is a <a href="https://docs.fastly.com/guides/vcl-snippets/using-dynamic-vcl-snippets">dynamic snippet</a> or <a href="https://docs.fastly.com/guides/vcl-snippets/using-regular-vcl-snippets">regular snippet</a>.</td>
</tr>
<tr>
<td>active</td>
<td>Indicates if the snippet or version is activated and currently in use. Returns <code>true</code> or <code>false</code>. Make note of the version number for an active snippet. You will use this to clone the version. </td>
</tr>
</table>

<p>The following is an example of a returned JSON for a customer VCL snippet:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"62Yd1WfiCBPENLloXfXmlO"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"service_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{Service ID}"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{Editable Version #}"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"apply_acl"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"priority"</span><span class="p">:</span><span class="w"> </span><span class="s2">"100"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"dynamic"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"hit"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"content"</span><span class="p">:</span><span class="w"> </span><span class="s2">"if ((client.ip ~ {ACLNAME}) &amp;&amp; !req.http.Fastly-FF){ error 403; }"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"created_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2016-08-15T09:37:10+00:00"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"updated_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2016-08-15T09:37:10+00:00"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"deleted_at"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<h2 id="prepare">Prepare to create VCL snippets</h2>
<p>Before creating custom VCL snippets, you need to set up and save two bash script files, one for each Staging and Production. Each file will include the specific Fastly Service ID per environment. When creating VCL snippets, you will create a series of VCL snippet files (<code class="highlighter-rouge">.vcl</code>) with JSON code. The bash scripts run through all <code class="highlighter-rouge">.vcl</code> files, creating and running CURL commands, to push custom VCL snippets to Staging or Production for a cloned version.</p>

<p>Anytime you want to add or edit existing VCLs, you will need to edit the files and change the version number to match the new cloned version.</p>

<p>To create the bash script files:</p>

<ol>
  <li>
    <p>Copy the following bash script.</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="c">#!/bin/bash</span>
   <span class="c">#############################################################################</span>
   <span class="c"># Upload snippets from the current directory</span>
   <span class="c">#</span>
   <span class="c"># Requires you to specify following environment variables</span>
   <span class="c">#  VERSION - The new cloned version of the VCL</span>
   <span class="c">#  SERVICE_ID - Service ID for Staging or Production</span>
   <span class="c">#  API_KEY - Fastly API Key for your account</span>
   <span class="c">#############################################################################</span>
   <span class="k">if</span> <span class="o">[</span> <span class="s2">"x</span><span class="nv">$VERSION</span><span class="s2">"</span> <span class="o">==</span> <span class="s2">"x"</span> <span class="nt">-o</span>  <span class="s2">"x</span><span class="nv">$SERVICE_ID</span><span class="s2">"</span> <span class="o">==</span> <span class="s2">"x"</span> <span class="nt">-o</span> <span class="s2">"x</span><span class="nv">$API_KEY</span><span class="s2">"</span> <span class="o">==</span> <span class="s2">"x"</span> <span class="nt">-o</span> <span class="s2">"xSNIPPET_NAME_PREFIX"</span> <span class="o">==</span> <span class="s2">"x"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
   </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">ENDOF</span><span class="sh">
   This script upload snippets from the local directory to their appropriate snippet type e.g. recv.vcl
   to recv type, fetch.vcl to fetch type etc.
   You need to define these variables
        export VERSION=&lt;SERVICE_ID_VERSION&gt;
        export SERVICE_ID=&lt;SERVICE_ID&gt;
        export API_KEY=&lt;API_KEY&gt;
        export SNIPPET_NAME_PREFIX=&lt;SNIPPET_NAME_PREFIX_NO_SPACES&gt;
</span><span class="no">   ENDOF
</span>   <span class="nb">exit </span>1
   <span class="k">fi
   </span>rawurlencode<span class="o">()</span> <span class="o">{</span>
   <span class="k">while </span><span class="nv">IFS</span><span class="o">=</span><span class="s2">""</span> <span class="nb">read</span> <span class="nt">-r</span> string<span class="p">;</span> <span class="k">do
       </span><span class="nb">local </span><span class="nv">strlen</span><span class="o">=</span><span class="k">${#</span><span class="nv">string</span><span class="k">}</span>
       <span class="nb">local </span><span class="nv">encoded</span><span class="o">=</span><span class="s2">""</span>
       <span class="nb">local </span>pos c o
       <span class="k">for</span> <span class="o">((</span> <span class="nv">pos</span><span class="o">=</span>0 <span class="p">;</span> pos&lt;strlen <span class="p">;</span> pos++ <span class="o">))</span><span class="p">;</span> <span class="k">do
            </span><span class="nv">c</span><span class="o">=</span><span class="k">${</span><span class="nv">string</span>:<span class="nv">$pos</span>:1<span class="k">}</span>
            <span class="k">case</span> <span class="s2">"</span><span class="nv">$c</span><span class="s2">"</span> <span class="k">in</span>
                   <span class="o">[</span><span class="nt">-_</span>.~a-zA-Z0-9] <span class="p">)</span> <span class="nv">o</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">c</span><span class="k">}</span><span class="s2">"</span> <span class="p">;;</span>
                   <span class="k">*</span> <span class="p">)</span>               <span class="nb">printf</span> <span class="nt">-v</span> o <span class="s1">'%%%02x'</span> <span class="s2">"'</span><span class="nv">$c</span><span class="s2">"</span>
            <span class="k">esac
            </span>encoded+<span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">o</span><span class="k">}</span><span class="s2">"</span>
       <span class="k">done
       </span><span class="nb">echo</span> <span class="nt">-n</span> <span class="s2">"</span><span class="k">${</span><span class="nv">encoded</span><span class="k">}</span><span class="s2">"</span>
       <span class="nb">echo</span> <span class="nt">-n</span> %0A
   <span class="k">done</span>
   <span class="o">}</span>
   <span class="c"># Find all VCLs in this directory</span>
   <span class="k">for </span>vcl <span class="k">in</span> <span class="k">*</span>.vcl
   <span class="k">do
   </span><span class="nv">TYPE</span><span class="o">=</span><span class="k">${</span><span class="nv">vcl</span><span class="p">%.vcl</span><span class="k">}</span>
   curl <span class="nt">-X</span> POST <span class="nt">-s</span> https://app.fastly.com/service/<span class="k">${</span><span class="nv">SERVICE_ID</span><span class="k">}</span>/version/<span class="k">${</span><span class="nv">VERSION</span><span class="k">}</span>/snippet <span class="se">\</span>
   <span class="nt">-H</span> <span class="s1">'Content-Type: application/json'</span>
   <span class="nt">-H</span> <span class="s2">"Fastly-Key:</span><span class="nv">$API_KEY</span><span class="s2">"</span> <span class="se">\</span>
   <span class="nt">--data</span> <span class="s2">"name=</span><span class="k">${</span><span class="nv">SNIPPET_NAME_PREFIX</span><span class="k">}</span><span class="s2">_</span><span class="k">${</span><span class="nv">TYPE</span><span class="k">}</span><span class="s2">&amp;type=</span><span class="nv">$TYPE</span><span class="s2">&amp;dynamic=0&amp;content=</span><span class="k">$(</span><span class="nb">cat</span> <span class="nv">$vcl</span> | rawurlencode<span class="k">)</span><span class="s2">"</span><span class="p">;</span>
   <span class="k">done</span>
</code></pre></div>    </div>
  </li>
  <li>Save two versions of the file: <code class="highlighter-rouge">staging_snippets.sh</code> and <code class="highlighter-rouge">production_snippets.sh</code>.</li>
  <li>
    <p>In <code class="highlighter-rouge">staging_snippets.sh</code>, edit the following values and save:</p>

    <ul>
      <li><code class="highlighter-rouge">SERVICE_ID</code>: Replace <code class="highlighter-rouge">&lt;SERVICE_ID&gt;</code> with the Service ID for your Staging environment.</li>
      <li><code class="highlighter-rouge">API_KEY</code>: Replace <code class="highlighter-rouge">&lt;API_KEY&gt;</code> with your Fastly API Key.</li>
      <li><code class="highlighter-rouge">SNIPPET_NAME_PREFIX</code>: Replace <code class="highlighter-rouge">&lt;SNIPPET_NAME_PREFIX_NO_SPACES&gt;</code> with a value of your choice. Do not use <code class="highlighter-rouge">magentocloud</code> as the prefix.</li>
    </ul>
  </li>
  <li>
    <p>In <code class="highlighter-rouge">production_snippets.sh</code>, edit the following values and save:</p>

    <ul>
      <li><code class="highlighter-rouge">SERVICE_ID</code>: Replace <code class="highlighter-rouge">&lt;SERVICE_ID&gt;</code> with the Service ID for your Staging environment.</li>
      <li><code class="highlighter-rouge">API_KEY</code>: Replace <code class="highlighter-rouge">&lt;API_KEY&gt;</code> with your Fastly API Key.</li>
      <li><code class="highlighter-rouge">SNIPPET_NAME_PREFIX</code>: Replace <code class="highlighter-rouge">&lt;SNIPPET_NAME_PREFIX_NO_SPACES&gt;</code> with a value of your choice. Do not use <code class="highlighter-rouge">magentocloud</code> as the prefix.</li>
    </ul>
  </li>
  <li>Optional, save the files to their own directories.</li>
</ol>

<p>For example if you want different custom VCL snippets for Staging then Production, you can save the <code class="highlighter-rouge">staging_snippets.sh</code> bash script and Staging <code class="highlighter-rouge">.vcl</code> files into the same directory. When you run that bash script, only those custom VCLs generate to Staging.</p>

<div class="bs-callout bs-callout-warning">
  <p>When modifying the bash scripts, make sure to carefully enter the correct Service ID. Fastly assigns different Service IDs per Staging and Production environments.</p>
</div>

<h2 id="process">The custom VCL snippet process</h2>
<p>To create custom VCLs, you should have the bash script prepared and saved to a directory. You can then continue with the following:</p>

<ol>
  <li><a href="#list">Locate the active version</a> for VCL snippets. You will use this version to clone.</li>
  <li><a href="#clone">Clone the active VCL snippet version</a> to generate a new version. All changes will save to this new version. Save this version number!</li>
  <li><a href="#create-snippet">Modify or add VCL snippets</a> in <code class="highlighter-rouge">.vcl</code> files. We provide a number of examples to get you started.</li>
  <li><a href="#run-bash">Run the bash scripts</a> to add and update VCL snippets to Fastly. The bash script runs through all of the <code class="highlighter-rouge">.vcl</code> files, generating and running the CURL commands for you.</li>
  <li><a href="#validate">Validate and activate</a> the version number and all associated VCL snippets.</li>
</ol>

<p>The following are <strong>best practices and recommendations</strong>:</p>

<ul>
  <li>The default VCL snippets you uploaded included a prepended name of <code class="highlighter-rouge">magentomodule_</code> with a priority of 50. For your custom VCL snippets, <strong>do not use the <code class="highlighter-rouge">magentomodule_</code> name</strong>. Also consider the priority of your custom snippets if they should override the default snippets.</li>
  <li>This process allows you to create and update multiple VCL snippets by running the bash script. It generates and runs the <code class="highlighter-rouge">cURL</code> command for you using all VCL JSON snippet files (<code class="highlighter-rouge">.vcl</code>) in the directory.</li>
  <li>If you want different values and settings or different VCLs per Staging and Production, create two directories: one for each environment. Save the specific bash script and VCL files to each one. Then move to those directories when done and run those scripts during step 4. If you keep everything in the same directory and run both bash scripts, the VCLs are added to both Staging and Production.</li>
  <li>If you decide to delete a VCL, save the VCL file to another archive folder. If you want to add it back, you can move the file back into the folder with the bash script and perform the steps again for updating your custom snippets.</li>
  <li>Don’t forget to always locate the active version, clone, and edit the bash script with the new version! Version is not part of your VCL snippet files.</li>
  <li>If you want to override values and settings from the <a href="https://github.com/fastly/fastly-magento2/tree/master/etc/vcl_snippets" target="_blank">default Fastly VCL snippets</a>, we recommend creating a new snippet with updated values and code with a higher priority value of 100. You should not try overwriting default VCLs. We provide an example for <a href="/guides/v2.2/cloud/configure/fastly-vcl-extend-timeout.html">Custom extend Admin timeout VCL</a>.</li>
</ul>

<h2 id="list">Locate the currently active VCL snippet version</h2>
<p>To view an entire list of all VCL snippets by version, use the following command:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -X GET -s https://api.fastly.com/service/&lt;Service ID&gt;/version -H "Fastly-Key:FASTLY_API_TOKEN"
</code></pre></div></div>

<p>Look for the <code class="highlighter-rouge">active</code> key from the returned list. This is the version you will clone in the next section.</p>

<p>For more information on this Fastly API, see this <a href="https://docs.fastly.com/api/config#version_dfde9093f4eb0aa2497bbfd1d9415987" target="_blank">get version command</a>.</p>

<h2 id="clone">Clone the active VCL version and all snippets</h2>
<p>Clone the version using the active version number. This creates a copy of all existing VCL snippets for that version with a new version number. After you clone the version, you can <a href="#create-snippet">modify and add</a> VCL snippets. Save the new version number as you will need it for the bash script.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -H "Fastly-Key: {FASTLY_API_TOKEN}" -H 'Content-Type: application/json' -H "Accept: application/json" -X PUT https://api.fastly.com/service/{Service ID}/version/{Current Active Version #}/clone
</code></pre></div></div>

<p>For more information on this Fastly API, see this <a href="https://docs.fastly.com/api/config#version_7f4937d0663a27fbb765820d4c76c709" target="_blank">clone command</a>.</p>

<!-- They should clone then edit. Saving this info just in case.
### Get a service version number {#version-number}
When creating a new regular VCL snippet, or updating a current one, you need a new version number. This version is a new service configuration version number for your Fastly service. When adding VCL snippets, you add them all to a specific version of the service. You may have noticed the versioning when you upload VCLs during Fastly configuration through the Fastly module.

When you validate and activate your snippets, you actually activate a version. All snippets assigned to the version activate.

To generate the version, use the following command with your Service ID and API key in the command:

	curl -H "Fastly-Key: {FASTLY_API_TOKEN}" -H 'Content-Type: application/json' -H "Accept: application/json" -X POST https://api.fastly.com/service/{Service ID}/version

Fastly returns the editable version number and Service ID. You use the version number when creating, calling, and managing VCL snippets. For example:

	{
		"number":1,
		"service_id": "SU1Z0isxPaozGVKXdv0eY"
	}

When reviewing a list of VCL snippets, you will also note the snippets have a specific version number in the JSON output. -->

<h3 id="create-snippet">Create custom VCL snippets</h3>
<p>We recommend the following process for creating and modifying snippets. The process allows you to push code for one or more snippets, save the code used, and formats the CURL commands just by running the bash scripts you prepared.</p>

<p>Create a VCL snippet as a <code class="highlighter-rouge">.vcl</code> file with the following JSON content and format:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;name&gt;"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"priority"</span><span class="p">:</span><span class="w"> </span><span class="s2">"100"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;type&gt;"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"content"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;code all in one line&gt;"</span><span class="p">,</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<p>The values include:</p>

<ul>
  <li><code class="highlighter-rouge">name</code>: Name for the VCL snippet</li>
  <li><code class="highlighter-rouge">priority</code>: Determines the order VCL snippets call. Lower values run first, from 1 to 100. All Magento module uploaded snippets are 50. If you want an action to occur last or override Magento default VCL snippets, enter a higher number like 100. To have code occur immediately, enter a lower value like 5.</li>
  <li><code class="highlighter-rouge">type</code>: Specifies the location to place the generated snippet such as <code class="highlighter-rouge">init</code> (above subroutines) and within subroutines like <code class="highlighter-rouge">recv</code>. See <a href="https://docs.fastly.com/api/config#snippet" target="_blank">Fastly VCL snippet object values</a> for information on these values.</li>
  <li><code class="highlighter-rouge">content</code>: The snippet of VCL code to run in one line, without line breaks.</li>
</ul>

<p>For detailed examples and custom code, see the following:</p>

<ul>
  <li><a href="/guides/v2.2/cloud/configure/fastly-vcl-whitelist.html">Custom whitelist VCL</a></li>
  <li><a href="/guides/v2.2/cloud/configure/fastly-vcl-blacklist.html">Custom blacklist VCL</a></li>
  <li><a href="/guides/v2.2/cloud/configure/fastly-vcl-extend-timeout.html">Custom extend Admin timeout VCL</a></li>
  <li><a href="/guides/v2.2/cloud/configure/fastly-vcl-wordpress.html">Custom redirect to Wordpress VCL</a></li>
  <li><a href="/guides/v2.2/cloud/configure/fastly-vcl-badreferer.html">Custom block bad referer VCL</a></li>
</ul>

<!-- ### Update an existing VCL snippet {#update}
Locate the snippet you want to update from the list of snippets included in the cloned version. You can use the following command to list the snippets:

	curl -X GET -s https://api.fastly.com/service/<Service ID>/version/<Cloned version #>/snippet/ -H "Fastly-Key:FASTLY_API_TOKEN"

Copy the data and build a `curl` command with the cloned version number, name, and edits. The following is an example template for the update command. You would enter the cloned version number for `Editable Version #` and data for the command in `--data`.

	curl -X PUT -s https://api.fastly.com/service/<Service ID>/version/<Editable Version #>/snippet/<Snippet Name e.g my_regular_snippet> -H "Fastly-Key:FASTLY_API_TOKEN" -H 'Content-Type: application/x-www-form-urlencoded' --data $'content=if ( req.url ) {\n set req.http.my-snippet-test-header = \"affirmative\";\n}';

If you want to override values and settings from the [default Fastly VCL snippets](https://github.com/fastly/fastly-magento2/tree/master/etc/vcl_snippets){:target="_blank"}, we recommend creating a new snippet with updated values and code with a priority of 100 (overrides the defaults). -->

<h2 id="run-bash">Update and run the bash scripts</h2>
<p>To add the VCL snippets to Fastly, you need to modify the bash scripts with the cloned version number and run the scripts.</p>

<p>Before running the bash scripts, make sure the <code class="highlighter-rouge">.vcl</code> files in the directory should be added to that environment. If you plan on having all of the same VCL settings for Staging and Production, you can keep all files in the same directory.</p>

<p>If you want different VCLs for Staging and Production, do the following:</p>

<ul>
  <li>Create a Staging directory with <code class="highlighter-rouge">staging_snippets.sh</code> and those <code class="highlighter-rouge">.vcl</code> files</li>
  <li>Create a Production directory with <code class="highlighter-rouge">production_snippets.sh</code> and those <code class="highlighter-rouge">.vcl</code> files</li>
</ul>

<p>To add custom snippets:</p>

<ol>
  <li>Edit the bash scripts <code class="highlighter-rouge">staging_snippets.sh</code> and <code class="highlighter-rouge">production_snippets.sh</code>.</li>
  <li>Change the value for <code class="highlighter-rouge">&lt;SERVICE_ID_VERSION&gt;</code> with the cloned version number in the line: <code class="highlighter-rouge">export VERSION=&lt;SERVICE_ID_VERSION&gt;</code></li>
  <li>Save the files.</li>
  <li>Run the bash script by entering the file name. The command generates and runs a CURL command for every <code class="highlighter-rouge">.vcl</code> file in the directory.</li>
</ol>

<ul>
  <li>Enter <code class="highlighter-rouge">production_snippets</code> to run that file and generate VCL snippets to Fastly for your Production environment.</li>
  <li>Enter <code class="highlighter-rouge">staging_snippets</code> to run that file and generate VCL snippets to Fastly for your Staging environment.
    <ol>
      <li>As the script runs, VCL snippets should be generating and uploading to Fastly.</li>
    </ol>
  </li>
</ul>

<h2 id="validate">Validate and activate snippets for a version</h2>
<p>When you add the VCL snippet(s) to the version, Fastly creates and assigns it to your service per that version number. Next, you should validate the entered VCL snippets with Fastly. Use the following command to validate all snippets for the version:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -H "Fastly-Key: {FASTLY_API_TOKEN}" -H 'Content-Type: application/json' -H "Accept: application/json" -X GET https://api.fastly.com/service/{Service ID}/version/{Editable Version #}/validate
</code></pre></div></div>

<p>Fastly should return: <code class="highlighter-rouge">"status": "ok"</code>. If you received an OK, activate the version for that service.</p>

<p>Assuming no errors (if there are errors, fix them before proceeding), the last step is to activate the version with the following command. All VCL snippets associated with the version activate and the previous version snippets deactivate.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -H "Fastly-Key: {FASTLY_API_TOKEN}" -H 'Content-Type: application/json' -H "Accept: application/json" -X PUT https://api.fastly.com/service/{Service ID}/version/{Editable Version #}/activate
</code></pre></div></div>

<p>If your received errors back from Fastly, track down the errors and update the specific snippet with the following command. Make sure to use the same version number you are working to activate.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -X PUT -s https://api.fastly.com/service/&lt;Service ID&gt;/version/&lt;Editable Version #&gt;/snippet/&lt;Snippet Name e.g my_regular_snippet&gt; -H "Fastly-Key:FASTLY_API_TOKEN" -H 'Content-Type: application/x-www-form-urlencoded' --data $'content=if ( req.url ) {\n set req.http.my-snippet-test-header = \"affirmative\";\n}';
</code></pre></div></div>

<p>For more information on these Fastly APIs, see <a href="https://docs.fastly.com/api/config#version_97f8cf7bfd5dc2e5ea1933d94dc5a9a6" target="_blank">validate</a> and <a href="https://docs.fastly.com/api/config#version_0b79ae1ba6aee61d64cc4d43fed1e0d5" target="_blank">activate</a> commands.</p>

<h2 id="manage-vcl">Manage regular VCL snippets with curl</h2>
<p>To review an individual snippet, enter the following API call in a terminal:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -X GET -s https://api.fastly.com/service/&lt;Service ID&gt;/version/&lt;Editable Version #&gt;/snippet/&lt;Snippet Name e.g my_regular_snippet&gt; -H "Fastly-Key:FASTLY_API_TOKEN"
</code></pre></div></div>

<p>To list all regular VCL snippets attached to a service, enter the following API call in a terminal:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -X GET -s https://api.fastly.com/service/&lt;Service ID&gt;/version -H "Fastly-Key:FASTLY_API_TOKEN"
</code></pre></div></div>

<p>If you want to override values and settings from the <a href="https://github.com/fastly/fastly-magento2/tree/master/etc/vcl_snippets" target="_blank">default Fastly VCL snippets</a>, we recommend creating a new snippet with updated values and code with a priority of 100 (overrides the defaults).</p>

<p>To delete an individual VCL snippet using the API, get a list of snippets and enter a <code class="highlighter-rouge">curl</code> command with the speicific snippet information to delete. We recommend keeping a copy of the <code class="highlighter-rouge">.vcl</code> file in an archive directory if you need to recreate it later.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -X DELETE -s https://api.fastly.com/service/&lt;Service ID&gt;/version/&lt;Editable Version #&gt;/snippet/&lt;Snippet Name e.g my_regular_snippet&gt; -H "Fastly-Key:FASTLY_API_TOKEN"
</code></pre></div></div>

<h4 id="fastly-resources">Fastly resources</h4>
<p>For Fastly resources on creating VCL snippets, you can review their docs:</p>

<ul>
  <li><a href="https://docs.fastly.com/guides/vcl/" target="_blank">All Fastly VCL content</a></li>
  <li><a href="https://docs.fastly.com/guides/vcl/guide-to-vcl" target="_blank">Fastly VCL guide</a></li>
  <li><a href="https://docs.fastly.com/guides/vcl/mixing-and-matching-fastly-vcl-with-custom-vcl" target="_blank">Mixing and matching Fastly VCL with custom VCL</a></li>
  <li><a href="https://docs.fastly.com/api/config#snippet" target="_blank">Fastly VCL snippet object values</a></li>
</ul>

<p>Fastly supports two types of snippets. We recommend and document how to create and use regular snippets.</p>

<ul>
  <li><a href="https://docs.fastly.com/guides/vcl-snippets/using-regular-vcl-snippets" target="_blank">Regular snippets</a> are versioned VCL snippets. The code and settings are locked per version to create, modify, and deploy with the Fastly service.</li>
  <li><a href="https://docs.fastly.com/guides/vcl-snippets/using-dynamic-vcl-snippets" target="_blank">Dynamic snippets</a> are snippets you can only create via API calls. These snippets do not have a version and deploy separately from your Fastly service.</li>
</ul>

<h4 id="related-topics">Related topics</h4>

<ul>
  <li><a href="/guides/v2.2/cloud/basic-information/cloud-fastly.html">Fastly in Cloud</a></li>
  <li><a href="/guides/v2.2/cloud/access-acct/fastly.html">Set up Fastly</a></li>
  <li><a href="/guides/v2.2/cloud/trouble/trouble_fastly.html">Troubleshoot Fastly</a></li>
</ul>

		</div>
		<!-- /.content-wrap -->

		<div class="page-info">

  

  
   <div class="github-link">
     <a class="improve-page" href="https://github.com/magento/devdocs/tree/develop/guides/v2.0/cloud/configure/cloud-vcl-custom-snippets.md" target="_blank">
       Edit this page on GitHub
     </a>
   </div>
  

  <div class="new-issue">
    <a href="https://github.com/magento/devdocs/issues/new?title=&body=Feedback on page: /guides/v2.2/cloud/configure/cloud-vcl-custom-snippets.html" target="_blank">Give us feedback</a>
  </div>

</div>


	</section>
	<!-- /.content -->

</div> <!-- /.container -->


	</div>
	<!-- /.main-container -->

</div>
<!-- /#gl-wrapper -->

<!-- footer-->
<div id="footer">
  <div class="container">

    <div class="copyright-links">
      <ul class="nav">
        <li><a href="/guides/v2.2/contributor-guide/contributing_docs.html">Become a Contributor</a>
        <li><a href="https://magento.github.io/glossary/index.html?audience=developer">Glossary</a></li>
        <li><a href="http://magento.com/legal/terms/privacy/">Privacy Policy</a></li>
        <li><a href="http://magento.com/legal/terms/">Terms of Service</a></li>
        <li><a href="http://magento.com/legal/licensing/">License/Trademark FAQ</a></li>
        <li><a href="/guides/v2.2/release-notes/bk-release-notes.html">Release Notes</a></li>
        <li><a href="/magento-third-party.html">Third-Party Licenses</a></li> 
      </ul>
    </div>

		<div class="copyright-date">&copy; 2017 Magento. All rights reserved.</div>

  </div>
</div>
<!-- / #footer -->

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script src="https://cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script>
<script src="/common/js/app.min.js"></script>

<!-- Glossary integration -->
<script src="https://cdn.jsdelivr.net/jquery.webui-popover/1.2.1/jquery.webui-popover.min.js"></script>
<script src="/common/js/glossary.tooltip.min.js"></script>
<script>
    $(document).ready(function(){
      magento.glossary.init("https://magento.github.io/glossary/data/content-glossary.xml",function(term){return term.types.includes("glossary");},magento.glossary.tooltip.init);
      });
</script>

<script type="text/javascript">
    (function() {
        var didInit = false;
        function initMunchkin() {
            if(didInit === false) {
                didInit = true;
                Munchkin.init('585-GGD-959', {cookieAnon: false});
            }
        }
        var s = document.createElement('script');
        s.type = 'text/javascript';
        s.async = true;
        s.src = '//munchkin.marketo.net/munchkin.js';
        s.onreadystatechange = function() {
            if (this.readyState == 'complete' || this.readyState == 'loaded') {
                initMunchkin();
            }
        };
        s.onload = initMunchkin;
        document.getElementsByTagName('head')[0].appendChild(s);
    })();
</script>



<!--Google Analytics-->
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-66243208-1', 'auto');
    ga('send', 'pageview');
</script>


</body>
</html>

